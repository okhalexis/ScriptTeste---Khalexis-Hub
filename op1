--[[
    NEXUS PRIME - PROFESSIONAL EDITION (REBORN)
    Re-arquitetado para Performance e Persistência
    Target: Roblox Engine v.2024
    UI Framework: WindUI
]]

-- // 1. SERVIÇOS DO SISTEMA
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Humanoid = Character:WaitForChild("Humanoid")
local RootPart = Character:WaitForChild("HumanoidRootPart")

-- // 2. ESTADO GLOBAL (PERSISTENTE)
_G.NexusConfig = _G.NexusConfig or {
    Speed = 16,
    CFrameSpeed = false,
    FlyEnabled = false,
    FlySpeed = 50,
    AutoFarm = false,
    SafetyProtocol = true,
    Theme = "Dark"
}
local State = _G.NexusConfig

-- // 3. SISTEMA DE PERSISTÊNCIA (AUTO-RECOVERY)
local function UpdateReferences(Char)
    Character = Char
    Humanoid = Char:WaitForChild("Humanoid")
    RootPart = Char:WaitForChild("HumanoidRootPart")
    
    -- Re-aplica configurações de física ao renascer
    Humanoid.WalkSpeed = State.Speed
end

LocalPlayer.CharacterAdded:Connect(UpdateReferences)

-- // 4. MOTORES DE MOVIMENTAÇÃO (ENGINE)

-- [ SPEED MELHORADO: CFRAME BYPASS ]
RunService.PreRender:Connect(function(delta)
    if Character and RootPart and Humanoid and State.CFrameSpeed then
        if Humanoid.MoveDirection.Magnitude > 0 then
            RootPart.CFrame = RootPart.CFrame + (Humanoid.MoveDirection * (State.Speed / 10))
        end
    end
end)

-- [ FLY MELHORADO: BODY VELOCITY ]
local FlyBV, FlyBG
local function ToggleFly(active)
    if active then
        FlyBV = Instance.new("BodyVelocity")
        FlyBG = Instance.new("BodyGyro")
        
        FlyBV.MaxForce = Vector3.new(1e8, 1e8, 1e8)
        FlyBV.Velocity = Vector3.zero
        FlyBV.Parent = RootPart
        
        FlyBG.MaxTorque = Vector3.new(1e8, 1e8, 1e8)
        FlyBG.P = 10000
        FlyBG.Parent = RootPart
    else
        if FlyBV then FlyBV:Destroy() end
        if FlyBG then FlyBG:Destroy() end
    end
end

RunService.Heartbeat:Connect(function()
    if State.FlyEnabled and RootPart then
        local cam = Workspace.CurrentCamera
        local moveDir = Vector3.zero
        
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - cam.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + cam.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0, 1, 0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveDir = moveDir - Vector3.new(0, 1, 0) end
        
        if FlyBV then
            FlyBV.Velocity = moveDir * State.FlySpeed
            FlyBG.CFrame = cam.CFrame
        end
    end
end)

-- [ GAP SYSTEM MELHORADO ]
local function TeleportToGap(gapName)
    -- Procura o gap em diferentes containers possíveis (mais robusto)
    local gap = Workspace:FindFirstChild(gapName, true) -- Busca recursiva
    if gap and gap:IsA("BasePart") then
        local targetPos = gap.Position + Vector3.new(0, 5, 0)
        
        -- Bypass simples de plataforma
        RootPart.CFrame = CFrame.new(targetPos)
        return true
    end
    return false
end

-- [ AUTO FARM: BRAINROT MONEY ]
task.spawn(function()
    while task.wait(0.1) do
        if State.AutoFarm then
            -- Procura por itens dropados (ajuste o nome "Money" ou "Coin" conforme o jogo)
            for _, item in pairs(Workspace:GetDescendants()) do
                if (item.Name:find("Money") or item.Name:find("Drop") or item.Name:find("Brain") or item.Name:find("Cash")) 
                and item:IsA("BasePart") and item.Transparency < 1 then
                    -- Teleporta o item para você (ou você para o item)
                    if (item.Position - RootPart.Position).Magnitude < 500 then
                        item.CFrame = RootPart.CFrame
                        -- Caso precise tocar:
                        -- firetouchinterest(RootPart, item, 0)
                    end
                end
            end
        end
    end
end)

-- // 5. INTERFACE WindUI
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Nexus Prime Reborn",
    Icon = "shield",
    Author = "Chief Dev",
    Folder = "NexusStudio",
    Transparent = true,
    Theme = State.Theme
})

-- [ ABA: PLAYER ]
local PlayerTab = Window:Tab({ Title = "Player", Icon = "user" })

PlayerTab:Toggle({
    Title = "CFrame Speed Bypass",
    Desc = "Usa um método de velocidade que jogos raramente detectam",
    Callback = function(v) State.CFrameSpeed = v end
})

PlayerTab:Slider({
    Title = "Velocidade",
    Value = {Min = 16, Max = 500, Default = State.Speed},
    Callback = function(v) State.Speed = v end
})

PlayerTab:Toggle({
    Title = "Fly (V)",
    Value = State.FlyEnabled,
    Callback = function(v) 
        State.FlyEnabled = v 
        ToggleFly(v)
    end
})

PlayerTab:Slider({
    Title = "Fly Speed",
    Value = {Min = 10, Max = 500, Default = State.FlySpeed},
    Callback = function(v) State.FlySpeed = v end
})

-- [ ABA: FARMING ]
local SellingTab = Window:Tab({ Title = "Selling", Icon = "shopping-cart" })

SellingTab:Toggle({
    Title = "Auto Farm Brainrot",
    Desc = "Puxa dinheiro e drops próximos automaticamente",
    Callback = function(v) State.AutoFarm = v end
})

SellingTab:Button({
    Title = "Destroy Barriers",
    Callback = function()
        local walls = Workspace:FindFirstChild("VIPWalls")
        if walls then walls:Destroy() end
    end
})

-- [ ABA: NAVIGATION ]
local NavTab = Window:Tab({ Title = "Events", Icon = "zap" })

local gaps = {"Gap1", "Gap2", "Gap3", "Gap4", "Gap5", "Gap6", "Gap7", "Gap8", "Gap9"}
NavTab:Dropdown({
    Title = "Select Gap Teleport",
    Values = gaps,
    Callback = function(v)
        local success = TeleportToGap(v)
        WindUI:Notify({
            Title = "Navigator",
            Content = success and "Teleportado para "..v or "Gap não encontrado!",
            Variant = success and "Success" or "Error"
        })
    end
})

-- [ ABA: SETTINGS ]
local SettingsTab = Window:Tab({ Title = "Settings", Icon = "settings" })

SettingsTab:Dropdown({
    Title = "Change Theme",
    Values = {"Dark", "Light", "Aqua", "Rose", "Amethyst"},
    Callback = function(t)
        Window:SetTheme(t)
        State.Theme = t
    end
})

SettingsTab:Button({
    Title = "Uninject Script",
    Callback = function() Window:Destroy() end
})

-- // 6. HOTKEYS E INICIALIZAÇÃO
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.V then
        State.FlyEnabled = not State.FlyEnabled
        ToggleFly(State.FlyEnabled)
        WindUI:Notify({Title = "Nexus", Content = "Fly: " .. (State.FlyEnabled and "ON" or "OFF")})
    end
end)

WindUI:Notify({
    Title = "Nexus Reborn Loaded",
    Content = "Sistemas persistentes ativos.",
    Icon = "check-circle"
})
