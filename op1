--[[
    NEXUS PRIME - PROFESSIONAL EDITION (V2)
    Bypassing: Character Attribute System & Tsunami Engine
    UI Framework: WindUI
]]

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

local LocalPlayer = Players.LocalPlayer

-- // 1. LÓGICA DE ESTADO (PERSISTENTE)
_G.NexusState = _G.NexusState or {
    Speed = 18,
    FlyEnabled = false,
    FlySpeed = 100,
    AutoFarm = false,
    Theme = "Dark",
    SafetyProtocol = true
}
local State = _G.NexusState

-- // 2. SISTEMA DE BYPASS DE MOVIMENTAÇÃO
-- O script do jogo usa atributos. Vamos forçar nossos valores neles.
local function ApplyBypass()
    local Char = LocalPlayer.Character
    if not Char then return end
    
    -- Enganando o script 'Character' do jogo
    LocalPlayer:SetAttribute("CurrentSpeed", State.Speed)
    LocalPlayer:SetAttribute("PreferredSpeed", State.Speed)
    LocalPlayer:SetAttribute("CoilMultiplier", 1.5) -- Aumenta o multiplicador base
    
    -- Previne o "SlowMode"
    LocalPlayer:SetAttribute("SlowMode", false)
    LocalPlayer:SetAttribute("InObby", false)
end

-- // 3. SISTEMA DE VOO ELITE (BODY VELOCITY)
local FlyBV, FlyBG
local function HandleFly()
    if State.FlyEnabled and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local Root = LocalPlayer.Character.HumanoidRootPart
        local Cam = Workspace.CurrentCamera
        
        if not FlyBV then
            FlyBV = Instance.new("BodyVelocity", Root)
            FlyBV.MaxForce = Vector3.new(1e8, 1e8, 1e8)
            FlyBG = Instance.new("BodyGyro", Root)
            FlyBG.MaxTorque = Vector3.new(1e8, 1e8, 1e8)
            FlyBG.P = 10000
        end
        
        local moveDir = Vector3.zero
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + Cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - Cam.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - Cam.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + Cam.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0, 1, 0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveDir = moveDir - Vector3.new(0, 1, 0) end
        
        FlyBV.Velocity = moveDir * State.FlySpeed
        FlyBG.CFrame = Cam.CFrame
    else
        if FlyBV then FlyBV:Destroy() FlyBV = nil end
        if FlyBG then FlyBG:Destroy() FlyBG = nil end
    end
end

-- // 4. AUTO FARM BRAINROT (DINHEIRO)
task.spawn(function()
    while task.wait(0.3) do
        if State.AutoFarm and LocalPlayer.Character then
            -- Procura por moedas/brainrot drops no mapa
            for _, item in pairs(Workspace:GetDescendants()) do
                if (item.Name:find("Money") or item.Name:find("Coin") or item.Name:find("Brain") or item.Name:find("Cash")) 
                and item:IsA("BasePart") then
                    -- Teleporta o item para você (ou encosta nele)
                    item.CFrame = LocalPlayer.Character.HumanoidRootPart.CFrame
                    -- firetouchinterest se o executor permitir
                    if firetouchinterest then
                        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, item, 0)
                        firetouchinterest(LocalPlayer.Character.HumanoidRootPart, item, 1)
                    end
                end
            end
        end
    end
end)

-- // 5. GAP NAVIGATION (CORRIGIDO)
local function GlideToGap(gapName)
    local Char = LocalPlayer.Character
    if not Char then return end
    
    -- Procura o Gap no container específico do seu mapa
    local gapsFolder = Workspace:FindFirstChild("DefaultMap") and Workspace.DefaultMap:FindFirstChild("Gaps")
    local target = gapsFolder and gapsFolder:FindFirstChild(gapName) or Workspace:FindFirstChild(gapName, true)
    
    if target then
        Char:PivotTo(target.CFrame * CFrame.new(0, 3, 0))
        return true
    end
    return false
end

-- // 6. INTERFACE WINDUI
local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Nexus Prime Reborn",
    Icon = "zap",
    Author = "Chief Dev",
    Folder = "NexusStudio",
    Transparent = true,
    Theme = State.Theme
})

-- [ PLAYER TAB ]
local PlayerTab = Window:Tab({ Title = "Player", Icon = "user" })

PlayerTab:Slider({
    Title = "Velocidade Real",
    Desc = "Bypassa o script de WalkSpeed do jogo via Attributes",
    Value = {Min = 18, Max = 300, Default = State.Speed},
    Callback = function(v) 
        State.Speed = v 
        ApplyBypass()
    end
})

PlayerTab:Slider({
    Title = "Fly Speed",
    Value = {Min = 50, Max = 500, Default = State.FlySpeed},
    Callback = function(v) State.FlySpeed = v end
})

PlayerTab:Button({
    Title = "Destroy VIP Walls",
    Callback = function()
        local vips = Workspace:FindFirstChild("VIPWalls")
        if vips then vips:Destroy() end
    end
})

-- [ SELLING (AUTO FARM) ]
local SellingTab = Window:Tab({ Title = "Selling", Icon = "shopping-cart" })

SellingTab:Toggle({
    Title = "Auto Farm Brainrot",
    Desc = "Puxa moedas e brains automaticamente",
    Value = State.AutoFarm,
    Callback = function(v) State.AutoFarm = v end
})

-- [ EVENTS (GAPS) ]
local EventsTab = Window:Tab({ Title = "Events", Icon = "map-pin" })

local gapList = {}
for i = 1, 10 do table.insert(gapList, "Gap" .. i) end

EventsTab:Dropdown({
    Title = "Teleport to Gap",
    Values = gapList,
    Callback = function(selected)
        local ok = GlideToGap(selected)
        WindUI:Notify({
            Title = "Navigator",
            Content = ok and "Teleportado para "..selected or "Gap não encontrado no mapa.",
            Variant = ok and "Success" or "Error"
        })
    end
})

-- [ SETTINGS ]
local SettingsTab = Window:Tab({ Title = "Settings", Icon = "settings" })

SettingsTab:Dropdown({
    Title = "Visual Theme",
    Values = {"Dark", "Light", "Aqua", "Rose", "Amethyst"},
    Callback = function(t)
        Window:SetTheme(t)
        State.Theme = t
    end
})

SettingsTab:Button({
    Title = "Uninject Script",
    Callback = function() Window:Destroy() end
})

-- // 7. LOOPS DE SINCRONIZAÇÃO
RunService.RenderStepped:Connect(function()
    ApplyBypass() -- Força os atributos a cada frame para ganhar do script original
    HandleFly()
end)

-- Garantir que funcione ao morrer
LocalPlayer.CharacterAdded:Connect(function()
    repeat task.wait() until LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    ApplyBypass()
    if State.FlyEnabled then HandleFly() end
end)

-- Keybind V para Fly
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.V then
        State.FlyEnabled = not State.FlyEnabled
        WindUI:Notify({Title = "Nexus", Content = "Voo: " .. (State.FlyEnabled and "Ativado" or "Desativado")})
    end
end)

WindUI:Notify({
    Title = "Nexus Prime Ativado",
    Content = "Sistemas de Bypass e AutoFarm carregados.",
    Icon = "check-circle"
})
